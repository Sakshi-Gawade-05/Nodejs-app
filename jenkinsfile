pipeline {
    agent any
  
    environment {
        DOCKER_IMAGE = 'nodejs-app'
        DOCKER_REGISTRY = 'sakshigawade'
        K8S_NAMESPACE = 'default'
    }
   stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/Sakshi-Gawade-05/Nodejs-app.git'
            }
        }
    }
    stages {
        stage('Build Docker Image') {
            steps {
              script{
                  sh'docker build -t $DOCKER_REGISTRY/$DOCKER_IMAGE .'
              }
            }
        }
     }
        stage('Push Docker Image') {
            steps {
                 script{
                  sh 'docker push $DOCKER_REFGISTRY/$DOCKER_IMAGE'
               }         
            }
         }  
        
        stage('Deploy to kubernetes') {
            steps {
                script{
                  sh """
                  kubectl set image deployment/node-app-deployment node-app=$DOCKER_REGISTRY/$DOCKER_IMAGE --namespace=$K8S_NAMESPACE 
                  kubectl rollout status deployment/node-app-deployment --namespace=$K8S_NAMESPACE
                  """
        }
    }
}
        stage('Rollback on Failure') {
            steps {
                script{
                  try {
                        sh'kubectl rollout undo deployment/node-app-deployment --namespace=$K8S_NAMESPACE'          
                      } catch (Exception e) {
                          echo "Rollback failed"
                      }
                    }
                  }
                }
            }

